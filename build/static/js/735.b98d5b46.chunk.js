"use strict";(self.webpackChunkdbr_ui=self.webpackChunkdbr_ui||[]).push([[735,161,118,406,834,249],{75646:function(t,n,e){e.d(n,{z:function(){return r}});e(83757);var i=e(94677),o=e(40807);function r(t){var n={method:o.lD.nodes.get.method,url:"".concat((0,o.kG)(),"/").concat(o.lD.nodes.get.resource,"?widget=").concat(t)};return(0,i.Z)(n).then((function(t){return t.data})).catch((function(t){return t}))}},30735:function(t,n,e){e.r(n),e.d(n,{default:function(){return M}});var i=e(45987),o=e(1413),r=e(4942),a=e(70885),c=e(72791),u=e(7993),s=e(73118),l=e(76834),d=e(83406),f=e(55161),m=e(75646),h=e(44249),p=e(36199),v=e(80184),g=["children","treeId"],b=["setMapData"],y={styles:d,disableDefaultUI:!0,gestureHandling:"auto",mapTypeId:"satellite"},N={},k=[],w={},x={height:"calc(100% - 42px)",width:"100%",borderRadius:"0 0 0.4rem 0.4rem"},C=function(t){return t&&t[0]&&t[0].polygonCoordinates&&t[0].polygonCoordinates.length>0?function(t){if(t){var n=new window.google.maps.LatLngBounds;return t.forEach((function(t){for(var e=t.polygonCoordinates,i=0;i<e.length;i++){var o=new window.google.maps.LatLng(e[i].lat||e[i][1],e[i].lng||e[i][0]);n.extend(o)}})),n}}(t):function(t){if(t&&t[0]){for(var n=new window.google.maps.LatLngBounds,e=0;e<t.length;e++){var i=new window.google.maps.LatLng(t[e].lat,t[e].lng);n.extend(i)}return n}}(t)},I=null,j=function(t){var n,e,i=t.handleMarkerClick,s=t.setBreadcrumb,l=t.getNodeAncestors,d=t.treeId;I=(0,u.YP)();var m=(0,c.useContext)(p.h),h=(null===m||void 0===m||null===(n=m.map[d])||void 0===n?void 0:n.mapNodes)||[],g=(null===m||void 0===m||null===(e=m.map[d])||void 0===e?void 0:e.currentNodeId)||null,b=(0,c.useState)({}),y=(0,a.Z)(b,2),N=y[0],k=y[1];(0,c.useEffect)((function(){if(I&&h){try{var t;I.fitBounds(C(h)),1===h.length&&null!==(t=h[0])&&void 0!==t&&t.kmzUrl&&I.setZoom(I.getZoom()-3)}catch(n){O="MAP_KEY_2",console.log("error",n)}s(l(g))}}),[h]);var w=function(t){return(0,v.jsx)(u.Cs,{url:t.kmzUrl,onClick:function(){i(t)},options:{preserveViewport:!0,suppressInfoWindows:!0}})},x=function(t){return(0,v.jsx)(u.Jx,{position:{lat:t.lat,lng:t.lng},icon:t.icon,onClick:function(){t.setInfoVisibility((0,r.Z)({},t._id,!0)),i(t)},children:N[t._id]&&(0,v.jsx)(u.nx,{children:(0,v.jsx)("h6",{children:t.name})})})},j=function(t){return(0,v.jsx)(f.default,{node:t,handleMarkerClick:i})},Z=c.useMemo((function(){return(0,v.jsx)(v.Fragment,{children:h&&h.map((function(t){return t?t.polygonCoordinates&&t.polygonCoordinates.length>0?(0,v.jsx)(j,(0,o.Z)({},t),t._id):t.kmzUrl?(0,v.jsx)(w,(0,o.Z)({},t),t._id):(0,v.jsx)(x,(0,o.Z)((0,o.Z)({},t),{},{infoVisibility:N,setInfoVisibility:k}),t._id):null}))})}),[h]);return(0,v.jsx)(v.Fragment,{children:Z})},Z=function(t){var n=t.handleMarkerClick,e=t.showNewStratificationOnMap,i=t.rootNodesIds,o=t.breadcrumb;(0,c.useEffect)((function(){e(i)}),[i]);var r=c.useCallback((function(){e("root")}),[i]);return k=o&&o.map((function(t,e){return o.length-1===e?(0,v.jsx)("li",{className:"breadcrumb-item-map active",children:(0,v.jsx)("button",{type:"button",className:"btn btn-sm btn-link",onClick:function(){n(t)},children:t.name||"Unknown"})},Math.random()):(0,v.jsx)("li",{className:"breadcrumb-item-map",children:(0,v.jsx)("button",{type:"button",className:"btn btn-sm btn-link",onClick:function(){n(t)},children:t.name||"Unknown"})},Math.random())})),(0,v.jsxs)("ol",{className:"breadcrumb bread-map",children:[(0,v.jsx)("li",{className:"bread-map-left-icon",children:(0,v.jsx)("i",{className:"simple-icon-map"})}),(0,v.jsx)("li",{className:"breadcrumb-item-map-map",children:(0,v.jsx)("button",{type:"button",className:"btn btn-sm btn-link",onClick:r,children:"Home"})}),k]})};function _(t){var n=t.children,e=t.treeId,r=(0,i.Z)(t,g),a=(0,c.useContext)(p.h).setMapData,u=function t(n,e){n&&(w[n.parent]&&t(w[n.parent],e),e.push(n))},s=function(t){var n=[];return u(w[t],n),n},l=function(t){var n,i=function(t){if(t&&t[0]&&t[0]in N)return t.map((function(t){return N[t]})).flat().reduce((function(t,n){return t.concat(n)}),[])}(t)||[null===(n=w)||void 0===n?void 0:n[t]];i&&i[0]&&t&&(a(e,{currentNodeId:1==t.length?t[0]:"root",nodes:i,mapNodes:i}),r.setBreadcrumb(s(t[0])))},d=function(t){l([].concat(t))},f=function(t){t&&t._id&&t.lat&&t.lng&&d(t._id)};return c.Children.map(n,(function(t){var n=(0,o.Z)((0,o.Z)({},t.props),{},{handleMarkerClick:f,showNewStratificationOnMap:d,getNodeAncestors:s,setBreadcrumb:r.setBreadcrumb});return c.isValidElement(t)?c.cloneElement(t,n):t}))}var O="MAP_KEY_1";var M=function(t){var n=t.widget;(0,h.default)({widgetId:n._id,treeId:n.tree._id});var e=(0,c.useState)((function(){return new l.default(s.default)})),r=(0,a.Z)(e,1)[0],d=(0,c.useContext)(p.h),f=d.setMapData,g=(0,i.Z)(d,b);console.log("====== other",g);var k=(0,u.Db)({googleMapsApiKey:"AIzaSyCzNqa1T_iZxs-eNClr8wyDIYzu3cdQs4Y"}),C=k.isLoaded,I=k.loadError,M=(0,c.useState)((function(){return{lat:33.58831,lng:-7.61138}})),S=(0,a.Z)(M,1)[0],E=(0,c.useState)(),P=(0,a.Z)(E,2),D=P[0],F=P[1],T=c.useReducer((function(t,n){return n}),[]),B=(0,a.Z)(T,2),W=B[0],A=B[1],L=function(t){var n;t&&Array.isArray(t)&&(N={},w={},t.forEach((function(t){var n=t.parent||"root";if(N[n]||(N[n]=[]),t.location){var e=t.location.coordinates[1],i=t.location.coordinates[0];w[t._id]=(0,o.Z)((0,o.Z)({},t),{},{lat:e,lng:i}),N[n].push((0,o.Z)((0,o.Z)({},t),{},{lat:e,lng:i}))}})),n=t,r.postMessage({action:"getNodesWithoutParent",stratificationTree:n}),r.onmessage=function(t){var e=t.data,i=e.action,o=e.nodesWithoutParent;if("getNodesWithoutParent"===i){var r=o[0]?o:n&&n[0]&&n[0]._id;F(r)}})};return(0,c.useEffect)((function(){(0,m.z)(n.tree._id).then((function(t){L(t);var e=t.map((function(t){return t.location?(0,o.Z)((0,o.Z)({},t),{},{lng:t.location.coordinates[0],lat:t.location.coordinates[1]}):t}));console.log("========= nodesData",e),f(n.tree._id,{fati:"mmmmmm"})}))}),[]),I?(0,v.jsx)("div",{children:"Map cannot be loaded right now, sorry."}):(0,v.jsxs)("div",{style:{height:"100%"},children:[(0,v.jsx)(_,{setBreadcrumb:A,treeId:n.tree._id,children:(0,v.jsx)(Z,{rootNodesIds:D,breadcrumb:W})}),C?(0,v.jsx)(u.b6,{id:"startification-map",mapContainerStyle:x,center:S,zoom:5,options:y,children:(0,v.jsx)(_,{setBreadcrumb:A,treeId:n.tree._id,children:(0,v.jsx)(j,{treeId:n.tree._id})})},O):(0,v.jsx)("div",{className:"loading"})]})}},55161:function(t,n,e){e.r(n);var i=e(1413),o=e(70885),r=e(72791),a=e(7993),c=e(80184),u={fillOpacity:.4,strokeColor:"#000",strokeOpacity:1,strokeWeight:1};n.default=function(t){var n=t.node,e=t.handleMarkerClick,s=(0,r.useState)(n.fillColor||"#000"),l=(0,o.Z)(s,2),d=l[0],f=l[1],m=(0,i.Z)((0,i.Z)({},u),{},{fillColor:d}),h=n.polygonCoordinates.map((function(t){return{lat:t[1],lng:t[0]}}));return(0,c.jsx)(a.mg,{paths:h,onClick:function(){e(n)},onMouseOver:function(){f("#e9e7a8")},onMouseOut:function(){f(n.fillColor||"#000")},options:m})}},73118:function(t,n,e){function i(){onmessage=function(n){var e=n.data,i=e.action,o=e.stratificationTree;if("getNodesWithoutParent"===i){var r=t(o);postMessage({action:i,nodesWithoutParent:r})}};var t=function(t){var n=t.map((function(t){return t._id}));return t.filter((function(t){var e=t.parent;return!n.includes(e)})).map((function(t){return t.parent}))}}e.r(n),e.d(n,{default:function(){return i}})},76834:function(t,n,e){e.r(n),e.d(n,{default:function(){return r}});var i=e(43144),o=e(15671),r=(0,i.Z)((function t(n){(0,o.Z)(this,t);var e=n.toString(),i=new Blob(["(".concat(e,")()")]);return new Worker(URL.createObjectURL(i))}))},44249:function(t,n,e){e.r(n);var i=e(72791),o=e(40807),r=e(87901),a=e(72525),c=e(36199);n.default=function(t){var n,e,u,s,l=t.widgetId,d=t.treeId,f=(0,i.useContext)(c.h),m=f.map,h=f.dashboard.widgets,p=f.setMapData,v=d||l,g=(null===(n=m[v])||void 0===n?void 0:n.currentNodeId)||null,b=(null===(e=m[v])||void 0===e?void 0:e.data)||[];(0,i.useEffect)((function(){return u=a.O.getNotification().subscribe((function(t){N(h,t,b)})),y(),function(){u&&u.unsubscribe()}}),[b,h]),(0,i.useEffect)((function(){var t;if(g){var n=b.find((function(t){var n=t._id;return g==n}));if(n){var e={};for(var i in n.metaData||{})e[i]=n.metaData[i]+"".split(",").map((function(t){return t.trim()}))[0];n.applicationParam&&(e[n.applicationParam]=n.name),!((null===(t=Object.keys(e))||void 0===t?void 0:t.length)>0)||d&&h[d]||k({fromWidgetKey:l,appParamsValue:e})}}}),[g]);var y=function(t){return(s=(0,r.ZP)(o.gs,{path:"/back/socket",transports:["websocket","polling"]})).on("connect",(function(){a.O.registerWidgetSocket(s)})),s.on("RECEIVE_NOTIFICATION",(function(n){n.widgetSocketId!=s.id&&(a.O.isWidgetRegistredInSocketPool(n.widgetSocketId)||N(t,n.widgetNotification,b))})),s},N=function(t,n,e){if(!(t&&d&&t[d])&&n.appParamsValue&&n.fromWidgetKey!=l){var i=n.appParamsValue,o=e.filter((function(t){var n=Object.keys(i).filter((function(n){return t.metaData&&t.metaData[n]}));return(null===n||void 0===n?void 0:n.length)>0&&n.every((function(n){return t.metaData[n]&&(""==i[n]||t.metaData[n].split(",").map((function(t){return t.trim()})).indexOf(i[n]+"")>-1)}))}));(null===o||void 0===o?void 0:o.length)>0&&p(d||l,{currentNodeId:1==o.length?o[0]._id:"root",mapNodes:o,nodes:o})}},k=function(t){a.O.sendNotification(t),s||(s=y(h)),s.emit("SEND_NOTIFICATION",{widgetSocketId:s.id,widgetNotification:t})};return{currentNodeId:g,notification:!0}}},83757:function(t,n,e){function i(t){Promise.resolve().then(t).catch((function(t){return setTimeout((function(){throw t}))}))}var o=function(){function t(){this.queue=[],this.transactions=0,this.notifyFn=function(t){t()},this.batchNotifyFn=function(t){t()}}var n=t.prototype;return n.batch=function(t){this.transactions++;var n=t();return this.transactions--,this.transactions||this.flush(),n},n.schedule=function(t){var n=this;this.transactions?this.queue.push(t):i((function(){n.notifyFn(t)}))},n.batchCalls=function(t){var n=this;return function(){for(var e=arguments.length,i=new Array(e),o=0;o<e;o++)i[o]=arguments[o];n.schedule((function(){t.apply(void 0,i)}))}},n.flush=function(){var t=this,n=this.queue;this.queue=[],n.length&&i((function(){t.batchNotifyFn((function(){n.forEach((function(n){t.notifyFn(n)}))}))}))},n.setNotifyFunction=function(t){this.notifyFn=t},n.setBatchNotifyFunction=function(t){this.batchNotifyFn=t},t}(),r=new o,a=e(54164).unstable_batchedUpdates;r.setBatchNotifyFunction(a);console;var c=console},45987:function(t,n,e){e.d(n,{Z:function(){return o}});var i=e(63366);function o(t,n){if(null==t)return{};var e,o,r=(0,i.Z)(t,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);for(o=0;o<a.length;o++)e=a[o],n.indexOf(e)>=0||Object.prototype.propertyIsEnumerable.call(t,e)&&(r[e]=t[e])}return r}},83406:function(t){t.exports=JSON.parse('[{"featureType":"all","elementType":"labels.icon","stylers":[{"visibility":"off"}]},{"featureType":"administrative.country","stylers":[{"visibility":"off"}]},{"featureType":"administrative.province","stylers":[{"visibility":"on"}]},{"featureType":"administrative.locality","stylers":[{"visibility":"on"}]}]')}}]);
//# sourceMappingURL=735.b98d5b46.chunk.js.map