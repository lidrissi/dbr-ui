"use strict";(self.webpackChunkdbr_ui=self.webpackChunkdbr_ui||[]).push([[428],{"./src/components/Widget/Tree/useNodeNotification.jsx":function(__unused_webpack_module,__webpack_exports__,__webpack_require__){__webpack_require__.r(__webpack_exports__);var react__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/react/index.js"),constants_resources__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__("./src/constants/resources.js"),socket_io_client__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__("./node_modules/socket.io-client/build/esm/index.js"),_services_NotificationService__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__("./src/services/NotificationService.js"),_services_context__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__("./src/services/context.js");__webpack_exports__.default=function useNodeNotification(_ref){var _map$id,_map$id2,subscription,socket,widgetId=_ref.widgetId,treeId=_ref.treeId,_useContext=(0,react__WEBPACK_IMPORTED_MODULE_0__.useContext)(_services_context__WEBPACK_IMPORTED_MODULE_4__.h),map=_useContext.map,widgets=_useContext.dashboard.widgets,setMapData=_useContext.setMapData,id=treeId||widgetId,currentNodeId=(null===(_map$id=map[id])||void 0===_map$id?void 0:_map$id.currentNodeId)||null,data=(null===(_map$id2=map[id])||void 0===_map$id2?void 0:_map$id2.data)||[];(0,react__WEBPACK_IMPORTED_MODULE_0__.useEffect)((function(){return subscription=_services_NotificationService__WEBPACK_IMPORTED_MODULE_3__.O.getNotification().subscribe((function(notification){handleNotification(widgets,notification,data)})),createSocket(),function(){subscription&&subscription.unsubscribe()}}),[data,widgets]),(0,react__WEBPACK_IMPORTED_MODULE_0__.useEffect)((function(){var _Object$keys;if(currentNodeId){var node=data.find((function(_ref2){var _id=_ref2._id;return currentNodeId==_id}));if(node){var appParamsValue={};for(var key in node.metaData||{})appParamsValue[key]=node.metaData[key]+"".split(",").map((function(i){return i.trim()}))[0];node.applicationParam&&(appParamsValue[node.applicationParam]=node.name),!((null===(_Object$keys=Object.keys(appParamsValue))||void 0===_Object$keys?void 0:_Object$keys.length)>0)||treeId&&widgets[treeId]||notifyAllWidgets({fromWidgetKey:widgetId,appParamsValue:appParamsValue})}}}),[currentNodeId]);var createSocket=function createSocket(widgets){return(socket=(0,socket_io_client__WEBPACK_IMPORTED_MODULE_2__.ZP)(constants_resources__WEBPACK_IMPORTED_MODULE_1__.gs,{path:"/back/socket",transports:["websocket","polling"]})).on("connect",(function(){_services_NotificationService__WEBPACK_IMPORTED_MODULE_3__.O.registerWidgetSocket(socket)})),socket.on("RECEIVE_NOTIFICATION",(function(notification){notification.widgetSocketId!=socket.id&&(_services_NotificationService__WEBPACK_IMPORTED_MODULE_3__.O.isWidgetRegistredInSocketPool(notification.widgetSocketId)||handleNotification(widgets,notification.widgetNotification,data))})),socket},handleNotification=function handleNotification(widgets,notification,nodes){if(!(widgets&&treeId&&widgets[treeId])&&notification.appParamsValue&&notification.fromWidgetKey!=widgetId){var appParams=notification.appParamsValue,selectedNodes=nodes.filter((function(node){var commonKeys=Object.keys(appParams).filter((function(key){return node.metaData&&node.metaData[key]}));return(null==commonKeys?void 0:commonKeys.length)>0&&commonKeys.every((function(key){return node.metaData[key]&&(""==appParams[key]||node.metaData[key].split(",").map((function(item){return item.trim()})).indexOf(appParams[key]+"")>-1)}))}));(null==selectedNodes?void 0:selectedNodes.length)>0&&setMapData(treeId||widgetId,{currentNodeId:1==selectedNodes.length?selectedNodes[0]._id:"root",mapNodes:selectedNodes,nodes:selectedNodes})}},notifyAllWidgets=function notifyAllWidgets(widgetNotification){_services_NotificationService__WEBPACK_IMPORTED_MODULE_3__.O.sendNotification(widgetNotification),socket||(socket=createSocket(widgets)),socket.emit("SEND_NOTIFICATION",{widgetSocketId:socket.id,widgetNotification:widgetNotification})};return{currentNodeId:currentNodeId,notification:!0}}}}]);